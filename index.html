<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Experimental</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-bg-solid: #ffffff;
            --text-primary: #0d1117;
            --text-secondary: #586069;
            --border-color: #d0d7de;
            --accent-primary: #0969da;
            --accent-primary-light: #ddf4ff;
            --accent-secondary: #1a7f37;
            --accent-secondary-light: #dcfce7;
            --positive: #1a7f37;
            --negative: #d73a49;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            --border-radius: 0.75rem;
            --transition-speed: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --backdrop-blur: blur(12px);
        }
        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-primary);
            margin: 0; padding: 2.5rem; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        .container { max-width: 1600px; margin: 0 auto; display: flex; flex-direction: column; gap: 2rem; }
        .card {
            background-color: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: var(--border-radius); box-shadow: var(--shadow);
            -webkit-backdrop-filter: var(--backdrop-blur); backdrop-filter: var(--backdrop-blur);
        }
        .header {
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1.5rem;
        }
        .header h1 { font-size: 2.5rem; font-weight: 700; color: var(--text-primary); margin: 0; }
        .controls { display: flex; gap: 1rem; align-items: center; }
        .toggle-switch { display: flex; background-color: #e9ecef; border-radius: 99px; padding: 0.25rem; }
        .toggle-switch button {
            padding: 0.5rem 1.25rem; border: none; background-color: transparent;
            font-weight: 600; border-radius: 99px; cursor: pointer; transition: all var(--transition-speed);
            color: var(--text-secondary);
        }
        .toggle-switch button.active { background-color: var(--card-bg-solid); color: var(--accent-primary); box-shadow: var(--shadow-sm); }
        .export-btn {
            background-color: var(--positive); color: white; padding: 0.6rem 1.25rem;
            border: none; font-weight: 600; border-radius: 0.5rem; cursor: pointer;
            transition: all var(--transition-speed); box-shadow: var(--shadow-sm);
        }
        .export-btn:hover { background-color: #176f32; box-shadow: var(--shadow); transform: translateY(-2px); }
        .main-controls-panel { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .scope-title { font-weight: 600; color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .year-control-area { display: flex; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .select-years-btn {
            background-color: var(--accent-primary-light); color: var(--accent-primary);
            border: 1px solid var(--accent-primary); padding: 0.6rem 1.25rem; border-radius: 99px;
            font-weight: 600; cursor: pointer; transition: all var(--transition-speed);
        }
        .select-years-btn:hover { background-color: var(--accent-primary); color: white; box-shadow: var(--shadow-sm); }
        #selectedYearsContainer { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
        .year-tag {
            display: inline-flex; align-items: center; gap: 0.5rem; background-color: var(--accent-primary);
            color: white; padding: 0.3rem 0.8rem; border-radius: 99px; font-weight: 500; font-size: 0.875rem;
        }
        .remove-tag-btn {
            background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer;
            padding: 0; width: 18px; height: 18px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; transition: background-color var(--transition-speed);
        }
        .remove-tag-btn svg { width: 12px; height: 12px; }
        .remove-tag-btn:hover { background: rgba(255,255,255,0.4); }
        .filters-area { display: grid; gap: 2rem; transition: grid-template-columns var(--transition-speed); align-items: start; }
        .filters-area.single-view { grid-template-columns: 1fr; }
        .filters-area.compare-view { grid-template-columns: 1fr auto 1fr; }
        .comparison-divider { display: flex; align-items: center; justify-content: center; height: 100%; padding-top: 5rem; }
        .comparison-divider span { font-size: 1.5rem; font-weight: 700; color: var(--text-secondary); background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .filter-set { padding: 1.5rem; }
        .filter-set h3.filter-set-title {
            margin: 0 0 1.5rem 0; font-size: 1.1rem; font-weight: 600; min-height: 2rem;
            display: flex; flex-wrap: wrap; justify-content: flex-start; align-items: center; gap: 0.25rem 0.5rem;
        }
        .filter-set.side-a { border-top: 4px solid var(--accent-primary); }
        .filter-set.side-b { border-top: 4px solid var(--accent-secondary); }
        .filter-set-title .title-year { font-weight: 700; padding: 0.1rem 0.5rem; border-radius: 0.25rem; }
        .filter-set-title .side-a { color: var(--accent-primary); background-color: var(--accent-primary-light); }
        .filter-set-title .side-b { color: var(--accent-secondary); background-color: var(--accent-secondary-light); }
        .filter-set-title .separator { color: var(--text-secondary); font-weight: 400; }
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .filter-group { position: relative; }
        .filter-group label {
            position: absolute; top: -0.65rem; left: 0.75rem; background-color: var(--card-bg-solid);
            padding: 0 0.25rem; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary);
        }
        .filter-group select {
            width: 100%; padding: 0.85rem; border: 1px solid var(--border-color); border-radius: 0.5rem;
            background-color: var(--card-bg-solid); font-size: 0.9rem; font-weight: 500; color: var(--text-primary);
            appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%2364748b'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.75rem center; cursor: pointer; transition: all var(--transition-speed);
        }
        .filter-group select:hover { border-color: var(--text-secondary); }
        .filter-group select.side-a:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-primary-light); }
        .filter-group select.side-b:focus { outline: none; border-color: var(--accent-secondary); box-shadow: 0 0 0 3px var(--accent-secondary-light); }
        .results-container { overflow-x: auto; }
        .results-table { width: 100%; border-collapse: collapse; }
        .results-table th, .results-table td { padding: 1rem 1.25rem; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .results-table thead th {
            background-color: #f6f8fa; font-weight: 600; font-size: 0.875rem;
            text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-secondary);
            position: sticky; top: 0; z-index: 10;
        }
        .results-table thead th.numeric-header { text-align: right; }
        .results-table thead th.col-side-b { background-color: var(--accent-secondary-light); }
        .results-table tbody tr:last-child td { border-bottom: none; }
        .results-table tbody tr:nth-child(even) { background-color: #f6f8fa; }
        .results-table tbody tr:hover { background-color: var(--accent-primary-light); }
        .metric-name { font-weight: 600; }
        .numeric { text-align: right; font-variant-numeric: tabular-nums; }
        .comparison-cell { display: flex; align-items: center; justify-content: flex-end; gap: 0.5rem; font-weight: 600; }
        .comparison-cell.positive { color: var(--positive); }
        .comparison-cell.negative { color: var(--negative); }
        .no-data-message, .loader { padding: 4rem; text-align: center; color: var(--text-secondary); font-size: 1.1rem; }
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity var(--transition-speed); }
        .popup-overlay.visible { display: flex; opacity: 1; }
        .popup-content { background-color: var(--card-bg-solid); border-radius: var(--border-radius); width: 90%; max-width: 500px; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; max-height: 80vh; transform: scale(0.95); transition: transform var(--transition-speed); }
        .popup-overlay.visible .popup-content { transform: scale(1); }
        .popup-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .popup-header h2 { margin: 0; font-size: 1.25rem; }
        .popup-close-btn { background:none; border:none; font-size: 1.5rem; cursor:pointer; color: var(--text-secondary); width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .popup-close-btn:hover { color: var(--text-primary); }
        .popup-toolbar { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 1rem; }
        .popup-search { flex-grow: 1; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.5rem; }
        .popup-toolbar button { padding: 0.5rem 1rem; border: 1px solid var(--border-color); border-radius: 0.5rem; background-color: var(--bg-color); cursor: pointer; font-weight: 500; }
        .popup-list { overflow-y: auto; padding: 1rem 1.5rem; }
        .popup-list-item { display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid #f1f5f9; cursor: pointer; border-radius: 0.5rem; }
        .popup-list-item:hover { background-color: #f6f8fa; }
        .popup-list-item:last-child { border-bottom: none; }
        .popup-list-item input[type="checkbox"] { margin-right: 1rem; width: 1rem; height: 1rem; accent-color: var(--accent-primary); }
        .popup-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); text-align: right; background-color: #f6f8fa; border-bottom-left-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); }
        .popup-done-btn { background-color: var(--accent-primary); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: background-color var(--transition-speed); }
        .popup-done-btn:hover { background-color: #085cc4; }
        @media (max-width: 900px) { .filters-area.compare-view { grid-template-columns: 1fr; } .comparison-divider { display: none; } }
        @media (max-width: 768px) { body { padding: 1rem; } .header { flex-direction: column; align-items: flex-start; } .filter-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="header"><h1>Dashboard Experimental</h1><div class="controls"><div class="toggle-switch"><button id="singleViewBtn" class="active">Single View</button><button id="compareViewBtn">Compare</button></div><button id="exportBtn" class="export-btn">Export CSV</button></div></header>
        <section class="main-controls-panel card" id="mainControlsPanel"><div class="scope-title">Single View: Year-over-Year Scope</div><div class="year-control-area"><button class="select-years-btn" id="selectYearsBtn">Select Years</button><div id="selectedYearsContainer"></div></div></section>
        <section id="filtersArea" class="filters-area"></section>
        <section id="resultsContainer" class="results-container card"></section>
    </div>
    <div class="popup-overlay" id="yearSelectorPopup"><div class="popup-content"><div class="popup-header"><h2>Select Years</h2><button class="popup-close-btn" title="Close"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button></div><div class="popup-toolbar"><input type="search" id="yearSearchInput" class="popup-search" placeholder="Filter years..."><button id="sortYearsBtn">Sort ASC/DESC</button><button id="selectAllYearsBtn">Select All</button><button id="deselectAllYearsBtn">Deselect All</button></div><div class="popup-list" id="yearList"></div><div class="popup-footer"><button id="donePopupBtn" class="popup-done-btn">Done</button></div></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const SHEET_ID = '122uThrt83Vs8rUtOe4PCmsWjLSxv8A-OmUbT0Y3PZeg';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;

    const defaultSingleViewFilters = { Region: 'all', Pharmacy: 'all', Month: 'all', Class: 'all' };
    const defaultCompareFilters = { Year: 'all', Region: 'all', Pharmacy: 'all', Month: 'all', Class: 'all' };

    const state = {
        allData: [],
        allYears: [],
        viewMode: 'single',
        analysisScopeYears: [],
        singleViewFilters: { ...defaultSingleViewFilters },
        compareFiltersA: { ...defaultCompareFilters },
        compareFiltersB: { ...defaultCompareFilters },
        yearSortOrder: 'desc',
    };

    const DOM = {
        mainControlsPanel: document.getElementById('mainControlsPanel'),
        singleViewBtn: document.getElementById('singleViewBtn'),
        compareViewBtn: document.getElementById('compareViewBtn'),
        exportBtn: document.getElementById('exportBtn'),
        selectYearsBtn: document.getElementById('selectYearsBtn'),
        selectedYearsContainer: document.getElementById('selectedYearsContainer'),
        filtersArea: document.getElementById('filtersArea'),
        resultsContainer: document.getElementById('resultsContainer'),
        yearPopup: {
            overlay: document.getElementById('yearSelectorPopup'),
            closeBtn: document.querySelector('#yearSelectorPopup .popup-close-btn'),
            doneBtn: document.getElementById('donePopupBtn'),
            searchInput: document.getElementById('yearSearchInput'),
            sortBtn: document.getElementById('sortYearsBtn'),
            selectAllBtn: document.getElementById('selectAllYearsBtn'),
            deselectAllBtn: document.getElementById('deselectAllYearsBtn'),
            list: document.getElementById('yearList'),
        },
    };

    const METRICS_CONFIG = [ 'المسكنات', 'مضادات حيوية', 'كلي', 'نفسية و عصبية', 'قلب', 'سكر حقن', 'سكر فم', 'نسا', 'كبد', 'جهاز هضمي', 'جهاز تنفسي', 'امراض جلدية', 'عيون و رمد', 'انف و اذن', 'مضادات تقلصات', 'اورام', 'فيتامينات', 'مختلفة' ];
    const MONTH_ORDER = { july: 1, august: 2, september: 3, october: 4, november: 5, december: 6, january: 7, february: 8, march: 9, april: 10, may: 11, june: 12, 'يوليو': 1, 'أغسطس': 2, 'سبتمبر': 3, 'أكتوبر': 4, 'نوفمبر': 5, 'ديسمبر': 6, 'يناير': 7, 'فبراير': 8, 'مارس': 9, 'أبريل': 10, 'مايو': 11, 'يونيو': 12 };
    const getMonthOrderValue = (month) => month ? MONTH_ORDER[String(month).trim().toLowerCase()] || 99 : 99;
    const CLOSE_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;

    const fetchData = async () => {
        DOM.resultsContainer.innerHTML = '<div class="loader">Loading data...</div>';
        try {
            const response = await fetch(SHEET_URL);
            if (!response.ok) throw new Error('Network response was not ok');
            const csvText = await response.text();
            Papa.parse(csvText, {
                header: true, skipEmptyLines: true,
                complete: (results) => {
                    state.allData = results.data.map(row => {
                        const newRow = {};
                        for (const key in row) { if (Object.prototype.hasOwnProperty.call(row, key)) { newRow[String(key).trim()] = typeof row[key] === 'string' ? String(row[key]).trim() : row[key]; } }
                        return newRow;
                    }).filter(row => row && Object.values(row).some(val => val != null && val !== ''));
                    initializeApp();
                }
            });
        } catch (error) { DOM.resultsContainer.innerHTML = `<div class="no-data-message">Error loading data. Please check connection and refresh.</div>`; console.error(error); }
    };
    
    const initializeApp = () => {
        state.allYears = [...new Set(state.allData.map(row => row.Year))].filter(Boolean).sort((a,b) => b - a);
        state.analysisScopeYears = state.allYears.slice(0, 2);
        setupEventListeners();
        renderLayout();
    };

    const setupEventListeners = () => {
        DOM.singleViewBtn.addEventListener('click', () => switchViewMode('single'));
        DOM.compareViewBtn.addEventListener('click', () => switchViewMode('compare'));
        DOM.exportBtn.addEventListener('click', exportData);
        DOM.selectYearsBtn.addEventListener('click', openYearPopup);
        DOM.selectedYearsContainer.addEventListener('click', handleYearTagRemove);
        DOM.filtersArea.addEventListener('change', handleFilterChange);
        DOM.yearPopup.overlay.addEventListener('click', (e) => e.target === DOM.yearPopup.overlay && closeYearPopup());
        DOM.yearPopup.closeBtn.addEventListener('click', closeYearPopup);
        DOM.yearPopup.doneBtn.addEventListener('click', () => { updateAnalysisScopeYearsFromPopup(); closeYearPopup(); renderLayout(); });
        DOM.yearPopup.searchInput.addEventListener('input', (e) => renderYearList(e.target.value));
        DOM.yearPopup.sortBtn.addEventListener('click', toggleYearSort);
        DOM.yearPopup.selectAllBtn.addEventListener('click', () => toggleAllYearsSelection(true));
        DOM.yearPopup.deselectAllBtn.addEventListener('click', () => toggleAllYearsSelection(false));
    };
    
    const switchViewMode = (mode) => {
        if (state.viewMode === mode) return;
        state.viewMode = mode;
        DOM.singleViewBtn.classList.toggle('active', mode === 'single');
        DOM.compareViewBtn.classList.toggle('active', mode === 'compare');
        
        if (mode === 'compare') {
            state.compareFiltersA = { ...defaultCompareFilters };
            state.compareFiltersB = { ...defaultCompareFilters };

            if (state.allYears.length > 0) {
                state.compareFiltersA.Year = state.allYears[0];
            }
            if (state.allYears.length > 1) {
                state.compareFiltersB.Year = state.allYears[1];
            } else if (state.allYears.length > 0) {
                state.compareFiltersB.Year = state.allYears[0];
            }
        }
        renderLayout();
    };

    const openYearPopup = () => { renderYearList(); DOM.yearPopup.overlay.classList.add('visible'); };
    const closeYearPopup = () => DOM.yearPopup.overlay.classList.remove('visible');
    
    const renderYearList = (searchTerm = '') => {
        const sortedYears = [...state.allYears].sort((a, b) => state.yearSortOrder === 'desc' ? b - a : a - b);
        const filteredYears = sortedYears.filter(year => `${year - 1}-${year}`.includes(searchTerm));
        DOM.yearPopup.list.innerHTML = filteredYears.map(year => `<label class="popup-list-item" for="year-check-${year}"><input type="checkbox" id="year-check-${year}" value="${year}" ${state.analysisScopeYears.includes(year) ? 'checked' : ''}><span>${year - 1}-${year}</span></label>`).join('');
    };
    
    const updateAnalysisScopeYearsFromPopup = () => { state.analysisScopeYears = Array.from(DOM.yearPopup.list.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value); };
    const toggleYearSort = () => { state.yearSortOrder = state.yearSortOrder === 'desc' ? 'asc' : 'desc'; renderYearList(DOM.yearPopup.searchInput.value); };
    const toggleAllYearsSelection = (select) => { DOM.yearPopup.list.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = select); };
    const handleYearTagRemove = (e) => { const button = e.target.closest('.remove-tag-btn'); if (button) { const yearToRemove = button.dataset.year; state.analysisScopeYears = state.analysisScopeYears.filter(y => y !== yearToRemove); renderLayout(); } };
    const renderAnalysisScopeTags = () => { DOM.selectedYearsContainer.innerHTML = state.analysisScopeYears.sort((a,b) => b-a).map(year => `<span class="year-tag">${year - 1}-${year}<button class="remove-tag-btn" data-year="${year}" title="Remove year">${CLOSE_ICON_SVG}</button></span>`).join(''); };

    const handleFilterChange = (e) => {
        if (e.target.tagName === 'SELECT') {
            const side = e.target.dataset.side;
            const filterKey = e.target.dataset.filter;
            const filterState = state.viewMode === 'single'
                ? state.singleViewFilters
                : (side === 'A' ? state.compareFiltersA : state.compareFiltersB);

            filterState[filterKey] = e.target.value;
            if (state.viewMode === 'compare') {
                updateFilterSetTitle(side);
            }
            updateAndRender();
        }
    };
    
    const renderLayout = () => {
        DOM.mainControlsPanel.style.display = state.viewMode === 'single' ? 'flex' : 'none';
        DOM.filtersArea.innerHTML = '';
        DOM.resultsContainer.innerHTML = '';
        DOM.filtersArea.className = `filters-area ${state.viewMode}-view`;
        
        if (state.viewMode === 'single') {
            DOM.filtersArea.appendChild(createFilterSet('A', 'Filters'));
        } else {
            const filterSetA = createFilterSet('A');
            const divider = document.createElement('div');
            divider.className = 'comparison-divider';
            divider.innerHTML = '<span>VS</span>';
            const filterSetB = createFilterSet('B');

            DOM.filtersArea.appendChild(filterSetA);
            DOM.filtersArea.appendChild(divider);
            DOM.filtersArea.appendChild(filterSetB);
        }
        updateAndRender();
    };

    const generateFilterSetTitle = (filters, side) => {
        const titleParts = [];
        let yearText = 'All Years';
        if (filters.Year && filters.Year !== 'all') { yearText = `${filters.Year - 1}-${filters.Year}`; }
        titleParts.push(`<span class="title-year side-${side.toLowerCase()}">${yearText}</span>`);
        ['Region', 'Pharmacy', 'Month', 'Class'].forEach(key => { if (filters[key] !== 'all') titleParts.push(`<span>${filters[key]}</span>`); });
        return titleParts.join('<span class="separator">·</span>');
    };

    const updateFilterSetTitle = (side) => {
        const titleEl = document.getElementById(`filterSetTitle-${side}`);
        if(titleEl) {
            const filters = side === 'A' ? state.compareFiltersA : state.compareFiltersB;
            titleEl.innerHTML = generateFilterSetTitle(filters, side);
        }
    };

    const createFilterSet = (side, title = '') => {
        const filterSet = document.createElement('div');
        filterSet.className = `filter-set card side-${side.toLowerCase()}`;
        
        let filtersToShow = ['Region', 'Pharmacy', 'Month', 'Class'];
        if (state.viewMode === 'compare') { filtersToShow.unshift('Year'); }

        const titleHTML = state.viewMode === 'compare' 
            ? `<h3 id="filterSetTitle-${side}" class="filter-set-title"></h3>`
            : `<h3 class="filter-set-title">${title}</h3>`;

        filterSet.innerHTML = `${titleHTML}<div class="filter-grid">${filtersToShow.map(filter => 
            `<div class="filter-group">
                <label for="${filter}Filter-${side}">${filter}</label>
                <select id="${filter}Filter-${side}" data-side="${side}" data-filter="${filter}" class="side-${side.toLowerCase()}"></select>
            </div>`).join('')}</div>`;
        
        filtersToShow.forEach(filterKey => populateSingleFilter(side, filterKey, filterSet));
        if (state.viewMode === 'compare') updateFilterSetTitle(side);
        return filterSet;
    };
    
    const getAvailableOptions = (filterKey) => {
        const uniqueValues = new Set(state.allData.map(row => row[filterKey]).filter(val => val != null && String(val).trim() !== ''));
        return Array.from(uniqueValues).sort((a,b) => {
            if (filterKey === 'Month') return getMonthOrderValue(a) - getMonthOrderValue(b);
            if (filterKey === 'Year') return b - a;
            return String(a).localeCompare(String(b), undefined, {numeric: true});
        });
    };
    
    const populateSingleFilter = (side, filterKey, container) => {
        const select = container.querySelector(`#${filterKey}Filter-${side}`);
        if(!select) return;
        
        const filterState = state.viewMode === 'single'
            ? state.singleViewFilters
            : (side === 'A' ? state.compareFiltersA : state.compareFiltersB);

        const options = getAvailableOptions(filterKey);
        select.innerHTML = `<option value="all">All ${filterKey}s</option>`;
        options.forEach(opt => {
            const displayText = filterKey === 'Year' ? `${opt - 1}-${opt}` : opt;
            select.add(new Option(displayText, opt))
        });
        select.value = filterState[filterKey] || 'all';
    };
    
    const getFilteredData = (filters) => {
        return state.allData.filter(row => 
            (filters.Year === 'all' || !filters.Year || row.Year === filters.Year) &&
            (filters.Region === 'all' || row.Region === filters.Region) &&
            (filters.Pharmacy === 'all' || row.Pharmacy === filters.Pharmacy) &&
            (filters.Month === 'all' || row.Month === filters.Month) &&
            (filters.Class === 'all' || row.Class === filters.Class)
        );
    };

    const calculateMetrics = (data) => {
        const metrics = { 'Total Value': 0, 'Total Prescriptions': 0, 'Insurance Covered': 0, 'Active Pharmacies': new Set(data.map(r => r.Pharmacy)).size };
        METRICS_CONFIG.forEach(cat => metrics[cat] = 0);
        data.forEach(row => {
            metrics['Total Prescriptions'] += parseFloat(row['Total Prescription'] || 0) || 0;
            metrics['Insurance Covered'] += parseFloat(row['Insurance Covered Prescription'] || 0) || 0;
            METRICS_CONFIG.forEach(cat => { const val = parseFloat(row[cat] || 0) || 0; metrics[cat] += val; metrics['Total Value'] += val; });
        });
        return metrics;
    };
    
    const updateAndRender = () => {
        if (state.viewMode === 'single') {
            renderAnalysisScopeTags();
            if(state.analysisScopeYears.length === 0) { DOM.resultsContainer.innerHTML = `<div class="no-data-message">Please select at least one year in the Analysis Scope.</div>`; return; }
            
            const yearlyMetricsData = {};
            state.analysisScopeYears.forEach(year => {
                const yearFilters = {...state.singleViewFilters, Year: year};
                yearlyMetricsData[year] = calculateMetrics(getFilteredData(yearFilters));
            });
            renderSingleTable(yearlyMetricsData);
        } else {
            renderCompareTable();
        }
    };
    
    const formatNumber = (num) => isNaN(num) ? 'N/A' : num.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    
    const renderSingleTable = (yearlyMetricsData) => {
        const years = Object.keys(yearlyMetricsData).sort((a,b) => b-a);
        if(years.length === 0) { DOM.resultsContainer.innerHTML = `<div class="no-data-message">No data for selected filters.</div>`; return; }
        const allMetrics = ['Total Value', 'Total Prescriptions', 'Insurance Covered', 'Active Pharmacies', ...METRICS_CONFIG];
        let tableHTML = `<table class="results-table"><thead><tr><th class="metric-header">Metric</th>`;
        years.forEach(year => tableHTML += `<th class="numeric-header">${year-1}-${year}</th>`);
        tableHTML += `</tr></thead><tbody>`;
        allMetrics.forEach(metric => {
            tableHTML += `<tr><td class="metric-name">${metric}</td>`;
            years.forEach(year => tableHTML += `<td class="numeric">${formatNumber(yearlyMetricsData[year][metric])}</td>`);
            tableHTML += `</tr>`;
        });
        DOM.resultsContainer.innerHTML = tableHTML + '</tbody></table>';
    };
    
    const renderCompareTable = () => {
        const metricsA = calculateMetrics(getFilteredData(state.compareFiltersA));
        const metricsB = calculateMetrics(getFilteredData(state.compareFiltersB));
        const allMetrics = ['Total Value', 'Total Prescriptions', 'Insurance Covered', 'Active Pharmacies', ...METRICS_CONFIG];
        let tableHTML = `<table class="results-table"><thead><tr><th class="metric-header">Metric</th><th>${generateFilterSetTitle(state.compareFiltersA, 'A')}</th><th class="col-side-b">${generateFilterSetTitle(state.compareFiltersB, 'B')}</th><th class="numeric-header">Comparison</th></tr></thead><tbody>`;
        allMetrics.forEach(metric => {
            const [valA, valB] = [metricsA[metric], metricsB[metric]];
            const diff = valB - valA;
            const perc = valA !== 0 ? (diff / Math.abs(valA)) * 100 : (valB > 0 ? Infinity : 0);
            const diffClass = diff > 0 ? 'positive' : (diff < 0 ? 'negative' : '');
            let comparisonContent = '–';
            if (diff !== 0) { const arrow = diff > 0 ? '▲' : '▼'; const percText = isFinite(perc) ? `${diff > 0 ? '+' : ''}${perc.toFixed(1)}%` : '∞'; comparisonContent = `${arrow} ${percText}`; }
            tableHTML += `<tr><td class="metric-name">${metric}</td><td class="numeric">${formatNumber(valA)}</td><td class="numeric">${formatNumber(valB)}</td><td class="numeric comparison-cell ${diffClass}" title="Change: ${formatNumber(diff)}">${comparisonContent}</td></tr>`;
        });
        DOM.resultsContainer.innerHTML = tableHTML + '</tbody></table>';
    };
    
    const exportData = () => {
        let dataToExport = [];
        const allMetrics = ['Total Value', 'Total Prescriptions', 'Insurance Covered', 'Active Pharmacies', ...METRICS_CONFIG];
        let filename;
        if (state.viewMode === 'single') {
            const yearlyMetricsData = {};
            state.analysisScopeYears.forEach(year => { 
                const yearFilters = {...state.singleViewFilters, Year: year}; 
                yearlyMetricsData[year] = calculateMetrics(getFilteredData(yearFilters)); 
            });
            const years = Object.keys(yearlyMetricsData).sort((a,b) => b-a);
            dataToExport = allMetrics.map(metric => { const row = { Metric: metric }; years.forEach(year => { row[`${year-1}-${year}`] = yearlyMetricsData[year][metric]; }); return row; });
            filename = `analytics_single-view_${new Date().toISOString().slice(0,10)}.csv`;
        } else {
            const metricsA = calculateMetrics(getFilteredData(state.compareFiltersA));
            const metricsB = calculateMetrics(getFilteredData(state.compareFiltersB));
            const titleA = generateFilterSetTitle(state.compareFiltersA, 'A').replace(/<[^>]*>/g, ' ').replace(/·/g, '-').trim();
            const titleB = generateFilterSetTitle(state.compareFiltersB, 'B').replace(/<[^>]*>/g, ' ').replace(/·/g, '-').trim();
            dataToExport = allMetrics.map(metric => {
                const [valA, valB] = [metricsA[metric], metricsB[metric]];
                const perc = valA !== 0 ? ((valB - valA) / Math.abs(valA)) * 100 : (valB > 0 ? Infinity : 0);
                return { Metric: metric, [titleA]: valA, [titleB]: valB, 'Comparison (%)': isFinite(perc) ? perc.toFixed(1) : 'N/A' };
            });
            filename = `analytics_comparison_${new Date().toISOString().slice(0,10)}.csv`;
        }
        if (dataToExport.length === 0) { alert("No data to export."); return; }
        generateCSV(dataToExport, filename);
    };

    const generateCSV = (data, filename) => {
        const csv = Papa.unparse(data);
        const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    
    fetchData();
});
</script>
</body>
</html>
